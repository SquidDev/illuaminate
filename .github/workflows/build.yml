name: CI

on: [ push, pull_request ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os:
        - windows-latest
        - ubuntu-latest

    name: Build
    runs-on: ${{matrix.os}}
    steps:
    - uses: actions/checkout@v2

    - name: Use OCaml
      uses: ocaml/setup-ocaml@v2
      with:
        # Could set ocaml-variants.4.13.1+options,ocaml-option-static,ocaml-option-musl here for Linux, but we don't
        # upload the Linux executable (yet!) - that's built with vampyroteuthis.
        # As an aside, we don't use flambda as that ends up much buliker than without.
        ocaml-compiler: 4.13.x

    - name: Install deps
      run: opam install . --deps-only --with-doc --with-test

    - name: Build
      run: opam exec -- dune build

    - name: Test
      run: opam exec -- dune runtest

    - name: Install
      run: |
        opam exec -- dune build -p illuaminate @install
        opam exec -- dune install --prefix=_install

    - name: Publish executable
      uses: actions/upload-artifact@v2
      with:
        name: illuaminate-windows-x86-64
        path: |
          _install/bin/illuaminate.exe
          _install/bin/illuaminate-lsp.exe
        if-no-files-found: error
      if: runner.os == 'Windows'

  upload_archives:
    name: Upload Windows Archives
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master'

    steps:
    - uses: actions/checkout@v2
    - name: Download executable
      uses: actions/download-artifact@v2
      with:
        name: illuaminate-windows-x86-64

    - name: Upload
      run: .github/workflows/deploy.sh 2> /dev/null
      env:
        SSH_KEY:  ${{ secrets.SSH_KEY  }}
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_PORT: ${{ secrets.SSH_PORT }}
